#!/bin/perl
#
#  C Object System
#  COS properties (filter)
# 
#  Copyright 2017+ Chris Marshall <chm@cpan.org>
#  Copyright 2007+ Laurent Deniau <laurent.deniau@gmail.com>
# 
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
# 
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.
#

use File::Basename;
use Getopt::Long;
use File::Path;

# default settings
$progname=basename($0);
$cpp="ucpp -I."; # "cc -E -I."
@infiles=();
@filelist=();
$out="_cosprp.c";
$datestr=scalar localtime();

# helper
sub usage() {

    print <<"END_OF_TEXT" ;

  $progname extracts COS defproperty from header files
  and outputs a C file which must be compiled/linked with your project.

  Usage:
    $progname <options> files

  Options:
    --help
      This help.

    --in=<file_name>
      Use the content of file_name to specify list of files
      Multiple files can be provided with multiple --in

    --out=<file_name>
      Put the result in file_name
      Default is: $out

    --cpp=<command>
      Specify the command for preprocessing the source files
      Default is: $cpp

END_OF_TEXT

    exit 1;
}

# parse arguments
GetOptions(
    "in=s" => \@filelist,
    "out=s" => \$out,
    "cpp=s" => \$cpp,
    "help" => \&usage,
) or usage();

# add @infiles to @filelist
foreach my $in ( @infiles ) {
    open IN, "<$in" or die "$progname: could not open '$in' for reading: $!";
    my (@inlist) = <IN>;
    close IN;
    @filelist = (@filelist, @inlist);
}

# add non-option files to @filelist
@filelist = (@filelist,@ARGV) if @ARGV;

# print "\$in = (@infiles)\n";
# print "\$out = '$out'\n";
# print "\$cpp = '$cpp'\n";
# print "\@filelist is (@filelist)\n"; 

##### Start of _cosprp.c #####

mkpath( dirname($out) );

open(my $outfh, ">", "$out") or die "cannot open > '$out': $!";

print $outfh <<"END_OF_TEXT" ;
/*
 * -----------------------------
 * COS properties
 *
 * DO NOT EDIT - DO NOT EDIT - DO NOT EDIT
 * This file was automatically generated by $progname
 * $datestr
 * -----------------------------
 */

#include <cos/Property.h>

END_OF_TEXT

my $prps = '';
for my $file (@filelist) {
    # retrieve properties
    my $prp= qx( $cpp -DCOS_NOCOS $file );
    $prp =~ tr/\n\t/  /;
    $prp =~ s/\b ( defproperty ) \s* \( ( [^;]* ) ; /\n\1(\2;\n/xg;
    $prp =~ s/\s*([()*])\s*/\1/g;  # remove whitespace around (, ), and *
    $prp =~ s/\s*,\s*/, /g;        # standardize whitespace around commas
    $prp = join( "\n", grep { m/^ defproperty \( [^;]* ; $/x } split "\n", $prp) . "\n";

    # includes (looks like a hack so build everything works)
    if ( $prp ) {
        $file =~ s,^.*include/,,;
        $file =~ s,^.*src/,,;
        print $outfh "#include \"$file\"\n";
        $prps .= "\n" . $prp;
    }
}

# makproperty
print $outfh "\n";
$prps =~ s/defproperty/makproperty/g;
@prps = sort split "\n", $prps;

# Could use List::Util uniq here
my %pdups = ();
foreach my $p (@prps) {
    next if $pdups{$p}++;
    print $outfh "$p\n";
}

##### Enf of _cosprp.c #####
close($outfh);

# end of script
