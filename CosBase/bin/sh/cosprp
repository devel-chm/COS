#!/bin/sh
#
#  C Object System
#  COS properties (filter)
# 
#  Copyright 2007+ Laurent Deniau <laurent.deniau@gmail.com>
# 
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
# 
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.
#

# default settings
progname=`basename $0`
cpp="cc -E -I."
filelist=
out="_cosprp.c"
datestr=`date`

# helper
usage() {

cat <<END-OF-TEXT

  $progname extracts COS defproperty from header files
  and outputs a C file which must be compiled/linked with your project.

  Usage:
    $progname <options> files

  Options:
    --help
      This help.

    --in=<file_name>
      Use the content of file_name to specify list of files
      Multiple files can be provided with multiple --in

    --out=<file_name>
      Put the result in file_name
      Default is: $out

    --cpp=<command>
      Specify the command for preprocessing the source files
      Default is: $cpp

END-OF-TEXT

    exit 1
}

# parse arguments
while [ "$1" != "" ] ; do

	val=`expr "$1" : '--in=\(.*\)'`
	if [ "$val" != "" ] ; then
		filelist="$filelist `cat $val`";
		shift; continue;
	fi

	val=`expr "$1" : '--out=\(.*\)'`
	if [ "$val" != "" ] ; then
		out="$val";
		shift; continue;
	fi

	val=`expr "$1" : '--cpp=\(.*\)'`
	if [ "$val" != "" ] ; then
		cpp="$val";
		shift; continue;
	fi

	if [ "$1" = "--help" -o \
	     "$1" =  "-help" ] ; then
    usage
	fi

	val=`expr "$1" : '--\(.*\)'`
	if [ "$val" != "" ] ; then
		echo "error: unknown option --$val"
		usage
	fi

	filelist="$filelist $1"
	shift

done

##### Start of _cosprp.c #####

mkdir -p `dirname $out`

cat > $out <<END-OF-TEXT
/*
 * -----------------------------
 * COS properties
 *
 * DO NOT EDIT - DO NOT EDIT - DO NOT EDIT
 * This file was automatically generated by $progname
 * $datestr
 * -----------------------------
 */

#include <cos/Property.h>

END-OF-TEXT

for f in $filelist ; do
  # retrieve properties
  prp=`$cpp -DCOS_NOCOS $f \
     | tr '\n\t' '  ' \
     | sed -e 's/[^A-Za-z0-9_]\(defproperty\)[ \t]*(\([^;]*\);/@\1(\2;@/g' \
     | tr '@' '\n' \
     | grep -E -e '^defproperty\([^;]*;$' \
     | sed -e 's/ *\([()]\) */\1/g' -e 's/ *)/)/g'`

  # includes
  if [ "$prp" != "" ] ; then
    f=`echo $f | sed -e 's,^.*include/,,' -e 's,^.*src/,,'`
    echo "#include \"$f\""               >> $out
    prps="$prps
$prp"
  fi
done

# makproperty
echo                                     >> $out
echo "$prps" \
  | sort -u \
  | sed -e 's/defproperty/makproperty/g' >> $out

##### Enf of _cosprp.c #####

# end of script
